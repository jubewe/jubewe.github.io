<!DOCTYPE html>
<html lang="en">
    <head>
        <title>L4L Stream Marker - Login</title>
        <link rel="icon" href="../../src/favicon.ico" type="image/x-icon">
    </head>
    <body style="background-color: #1d3956; color: mediumseagreen; font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif; text-transform: uppercase; font-size: 20px;">
        <div>
            <center>
                <h1>Stream Marker for Mods</h1>
            </center>
        </div>
        <div>
            <center>
                <h id="alert" style="color: red; font-size: 30px; display: none;">Alert</h>
            </center>
        </div>
        <div id="container-usage" style="text-transform: none; ">
            <center>
                <h>Usage:</h>
                <ol>
                    <li><a href="https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=ojvz4rc2je8m2l2sqva9tk4zyobzqk&redirect_uri=https://jubewe.github.io/liveforlife/&scope=channel:edit:commercial+channel:manage:broadcast+clips:edit+moderator:read:chat_settings+moderator:manage:chat_settings" style="color: currentColor;">Generate a Token with this Generator</a></li>
                    <li>Click on "Authorize"</li>
                    <li>nothing</li>
                </ol>
            </center>
        </div>
        <div id="container-mark" style="display: none;">
            <center>
                <div style="text-transform: none; border: double; display: inline-block; padding: 15px; background-color: #144747;">
                    <h>Channel: </h>
                    <input id="marker_channel" placeholder="Channel" value="liveforlifetv" style="border: none;">
                    <br><br>
                    <input id="marker_submit" type="button" value="Create Marker" style="background-color: darkcyan;">
                </div>
            </center>
        </div>
    </body>
</html>

<script>
    window.onload = () => {
        setTimeout(() => {
            onloada()
        }, 1000)
    }

    let clientid = "ojvz4rc2je8m2l2sqva9tk4zyobzqk"

    function onloada(){
        if(document.URL.includes("#access_token=")){
            let code = document.URL.split("#access_token=")[1].split("&")[0]
            let request = new XMLHttpRequest();
            request.open("GET", `https://id.twitch.tv/oauth2/validate`)
            request.setRequestHeader("Authorization",`Bearer ${code}`)
            request.addEventListener("load", function(r){
                let dat = JSON.parse(request.response)
                if(dat.status !== undefined){
                    al(1, "Error on validating token", "red", 10000)
                } else {
                    setCookie("token", code, 3600)
                    document.getElementById("container-usage").style.display = "none"
                    document.getElementById("container-mark").style.display = "block"
                    window.history.pushState("Authorized", "L4L Stream Marker", "index.html")
                }
            })
            request.addEventListener("error", function(e){
                al(1, "Error on Connecting with Twitch", "red", 10000)
            })
            request.send(null)
        } else {
            if(getCookie("token") !== ""){
                checktoken(getCookie("token"))
                .then(tokeninfo => {
                    console.log(tokeninfo)
                    document.getElementById("container-usage").style.display = "none"
                    document.getElementById("container-mark").style.display = "block"
                })
                .catch(err => {
                    console.log(err)
                    document.getElementById("container-usage").style.display = "block"
                    document.getElementById("container-mark").style.display = "none"
                })
            } else {
                document.getElementById("container-usage").style.display = "block"
                document.getElementById("container-mark").style.display = "none"
            }
        }
    }

    function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = `${cname}=${cvalue};${expires};SameSite=Strict;Secure;`
        // document.cookie = cname + "=" + cvalue + ";" + expires + ";SameSite=Strict;Secure;";
    }

    function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while(c.charAt(0) === ' '){
                c = c.substring(1);
            }
            if(c.indexOf(name) === 0){
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    
    function checkCookie(coname) {
        let co = getCookie(coname);
        if(co !== ""){
            return 1
        } else {
            return 0
        }
    } 

    async function checktoken(chtoken){
        return new Promise(function(resolve, reject){
            let checkrequest = new XMLHttpRequest();
            checkrequest.open("GET", "https://id.twitch.tv/oauth2/validate");
            checkrequest.setRequestHeader("Authorization",`Bearer ${chtoken}`);
            checkrequest.addEventListener("load", function(l){
                console.log("checking...");
                if(JSON.parse(checkrequest.responseText).error !== undefined){
                    console.log("check err 1");
                    checkrequest.send(null);
                    return reject(JSON.parse(checkrequest.responseText));
                } else {
                    console.log("checked");
                    checkrequest.send(null);
                    return resolve(JSON.parse(checkrequest.responseText));
                }
            })
            checkrequest.addEventListener("error", e => {
                console.log("check err 2");
                checkrequest.send(null);
                return reject(e);
            })
            checkrequest.addEventListener("readystatechange", event => {
                console.log(checkrequest.readyState)
            })
        })
    }

    function createmarker(){
        if(document.getElementById("marker_channel").value !== undefined && document.getElementById("marker_channel").value !== ""){
            if(getCookie("channelid") !== ""){
                proceedmarker()
            } else {
                getuserid(document.getElementById("marker_channel").value)
                .then(id => {
                    setCookie("channelid", id, 14)
                    proceedmarker()
                })
                .catch(err => {
                    al(1, "Error on getting ID - try to reset the token", "red", 10000)
                })
            }
            
        } else {
            al(1, "Error: No Channel given", "red", 10000)
        }

        function proceedmarker(){
            if(getCookie("channelid") !== ""){
                let request = new XMLHttpRequest();
                let requestmarkerheader = {
                    headers: {
                        "Authorization":getCookie("token"),
                        "Client-Id":clientid,
                        "Content-Type":"application/json"
                    },
                    body: `{"user_id":"${getCookie("channelid")}", "description":"${document.getElementById("")} "}`
                }
                request.setRequestHeader(requestmarkerheader)

                al(0, "Successfully Created Stream Marker", "green", 10000)
            } else {
                al(1, "Error: No Channel ID given", "red", 10000)
            }
            
        }

    }
    
    async function getuserid(gusidusername){
        return new Promise(function(resolve, reject){
            request(`https://api.twitch.tv/helix/users?login=${gusidusername.replace(replacer, "")}`, requestopts, function(e, r){
                if(e){
                    return reject("0 " + e)
                } else {
                    let dat = JSON.parse(r.body)
                    // console.log(dat)
                    if(dat.length < 30){
                      return reject("1 " + r.body)
                    } else if(dat.error !== undefined){
                      return reject("2 " + r.body)
                    } else {
                      return resolve(dat.data[0].id)
                    }
                }
            })
        })
    }

    function al(almode, almessage, alcolor, altimeout){
        if(almode === undefined || almode === 0){
            document.getElementById("alert").innerHTML = almessage
            document.getElementById("alert").style.color = alcolor
            document.getElementById("alert").style.display = "block"
            setTimeout(() => {
                document.getElementById("alert").style.display = "none"
            }, altimeout)
        } else if(almode === 1){
            document.getElementById("alert").innerHTML = almessage
            document.getElementById("alert").style.color = alcolor
            document.getElementById("alert").style.display = "block"
            setTimeout(() => {
                document.getElementById("alert").style.display = "none"
            }, altimeout)
        }
    }

</script>