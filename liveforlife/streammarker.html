<!DOCTYPE html>
<html lang="en">
    <head>
        <title>L4L Stream Marker</title>
        <link rel="icon" href="../../src/favicon.ico" type="image/x-icon">
    </head>
    <body style="background-color: #1d3956; color: mediumseagreen; font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif; text-transform: uppercase; font-size: 20px;">
        <div style="float: right;">
            <div>
                <input type="button" value="Remove token (website)" style="background-color: red;" onclick="removecookies()">
            </div>
        </div>
        <br>
        <div>
            <center>
                <h1>Stream Marker for Mods</h1>
            </center>
        </div>
        <div>
            <center>
                <h id="alert" style="color: red; font-size: 30px; display: none; padding-bottom: 10px;">Alert</h>
            </center>
        </div>
        <div id="container-usage" style="text-transform: none; display: none;">
            <center>
                <h>Usage:</h>
                <ol>
                    <li><a href="https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=ojvz4rc2je8m2l2sqva9tk4zyobzqk&redirect_uri=https://jubewe.github.io/liveforlife/streammarker&scope=channel:edit:commercial+channel:manage:broadcast+clips:edit+moderator:read:chat_settings+moderator:manage:chat_settings" style="color: currentColor;">Generate a Token with this Generator</a></li>
                    <li>Click on "Authorize"</li>
                    <li>that's all</li>
                </ol>
            </center>
        </div>
        <div id="container-mark" style="display: none;">
            <center>
                <div style="text-transform: none; border: double; display: inline-block; padding: 15px; background-color: #144747;">
                    <h>Channel: </h>
                    <input id="marker_channel" placeholder="Channel" value="liveforlifetv" style="border: none;">
                    <br>
                    <h>Description: </h>
                    <input id="marker_title" placeholder="Description" value="Auto Generated" style="border: none;">
                    <br><br>
                    <input id="marker_submit" type="button" value="Create Marker" style="background-color: darkcyan; border-color: darkblue;" onclick="createmarker()">
                    <br><br>
                    <textarea id="marker_info" style="background-color: darkcyan; border: none; width: 290px; height: 60px; max-width: 500px; min-width: 290px; max-height: 200px; min-height: 60px;" spellcheck="false">Info will be displayed here</textarea>
                </div>
            </center>
        </div>
    </body>
</html>

<script>
    onloada()

    let clientid = "ojvz4rc2je8m2l2sqva9tk4zyobzqk"

    function onloada(){
        if(document.URL.includes("#access_token=")){
            if(window.location.search.includes("?create")){
            let urlparams = window.location.search.replace("?create", "")
            if(urlparams !== ""){
                urlparams = urlparams.substring(1, urlparams.length);
                let urlparamsa = [];
                let urlparamsb = [];
                urlparams.split("&").forEach(up => {
                    urlparamsa.push(up.split("=")[0])
                    urlparamsb.push(up.split("=")[1])
                })
                if(urlparamsa.includes("channel")){
                    document.getElementById("marker_channel").value = urlparamsb[urlparamsa.indexOf("channel")]
                } 
                if(urlparamsa.includes("title")){
                    document.getElementById("marker_title").value = urlparamsb[urlparamsa.indexOf("title")]
                }
            }
            // createmarker()
        }
            let code = document.URL.split("#access_token=")[1].split("&")[0]
            let request = new XMLHttpRequest();
            request.open("GET", `https://id.twitch.tv/oauth2/validate`)
            request.setRequestHeader("Authorization",`Bearer ${code}`)
            request.addEventListener("load", function(r){
                let dat = JSON.parse(request.response)
                if(dat.status !== undefined){
                    
                } else {
                    setCookie("token", code, 14)
                    document.getElementById("container-usage").style.display = "none"
                    document.getElementById("container-mark").style.display = "block"
                    window.history.pushState("Authorized", "L4L Stream Marker", "streammarker.html")
                }
            })
            request.addEventListener("error", function(e){
                al(1, "Error on Connecting with Twitch", "red", 10000)
            })
            request.send(null)

        } else {
            if(checkCookie("token") === 1){
                window.location.href = "#access_token=" + getCookie("token")
                window.location.reload()
            } else {
                document.getElementById("container-usage").style.display = "block"
                document.getElementById("container-mark").style.display = "none"
            }
        }
    }

    function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";SameSite=Strict;Secure;";
    }

    function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while(c.charAt(0) === ' '){
                c = c.substring(1);
            }
            if(c.indexOf(name) === 0){
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    
    function checkCookie(coname) {
        let co = getCookie(coname);
        if(co !== ""){
            return 1
        } else {
            return 0
        }
    } 

    async function checktoken(chtoken){
        return new Promise(function(resolve, reject){
            let request = new XMLHttpRequest();
            request.open("GET", "https://id.twitch.tv/oauth2/validate")
            request.setRequestHeader("Authorization","Bearer " + chtoken.toLowerCase().replace("oauth:", ""))
            request.addEventListener("load", function(l){
                if(JSON.parse(request.responseText).error !== undefined){
                    request.send(null);
                    return reject(JSON.parse(request.responseText));
                } else {
                    request.send(null);
                    return resolve(JSON.parse(request.responseText));
                }
            })
            request.addEventListener("error", e => {
                request.send(null);
                return reject(e);
            })
        })
    }

    function createmarker(){
        al(0, "Loading", "orange", 2000)
        if(document.getElementById("marker_channel").value !== undefined && document.getElementById("marker_channel").value !== ""){
            if(getCookie("channelname") === document.getElementById("marker_channel").value.toLowerCase() && getCookie("channelid") !== ""){
                proceedmarker()
            } else {
                getuserid(document.getElementById("marker_channel").value)
                .then(id => {
                    setCookie("channelid", id, 14);
                    setCookie("channelname", document.getElementById("marker_channel").value, 14)
                    proceedmarker()
                })
                .catch(err => {
                    al(1, "Error on getting channelid", "red", 5000)
                    if(err === 1){
                        document.getElementById("marker_info").innerHTML = `ERROR\non getting channelid of ${document.getElementById("marker_channel").value}`
                    } else if(err === 2){
                        document.getElementById("marker_info").innerHTML = `ERROR\non getting channelid of ${document.getElementById("marker_channel").value}\nChannel not found`
                    }
                    
                })
            }
            
        } else {
            al(1, "Error: No Channel given", "red", 10000)
        }

        function proceedmarker(){
            if(getCookie("channelid") !== ""){
                try {
                    let request = new XMLHttpRequest();
                    request.open("POST", "https://api.twitch.tv/helix/streams/markers")
                    request.setRequestHeader("Authorization", `Bearer ${getCookie("token")}`);
                    request.setRequestHeader("Client-Id", clientid);
                    request.setRequestHeader("Content-Type","application/json");
                    request.addEventListener("load", (rload) => {
                        let dat = JSON.parse(request.responseText)
                        console.log(dat)
                        if(dat.error !== undefined){
                            al(1, "Error on creating marker", "red", 5000);
                            document.getElementById("marker_info").innerHTML = `ERROR ${dat.error}\nStatus: ${dat.status}\nCode: ${dat.message.split("code:")[1].split("message:")[0]}`
                        } else {
                            al(0, "Successfully Created Stream Marker", "green", 10000);
                            document.getElementById("marker_info").innerHTML = `Id: ${dat.data[0].id}\nCreated at ${dat.data[0].created_at.replace("T", " ").split(".")[0]}\nPosition: ${dat.data[0].position_seconds} (${millisToMinutesAndSeconds(dat.data[0].position_seconds*1000)})\nDescription: ${dat.data[0].description}`
                        }
                    })
                    request.addEventListener("error", (rerr) => {
                        al(1, `Error from API \n${request.responseText}`, "red", 10000);
                        console.error(request.responseText);
                    })
                    request.send(`{"user_id":"${getCookie("channelid")}","description":"${document.getElementById("marker_title").value}"}`)
                } catch(err){
                    document.getElementById("marker_info").innerHTML = `ERROR`
                }
            } else {
                al(1, "Error: No Channel ID given", "red", 10000)
            }
        }
    }
    
    async function getuserid(gusidusername){
        return new Promise(function(resolve, reject){
            let request = new XMLHttpRequest();
            request.open("GET", `https://api.twitch.tv/helix/users?login=${gusidusername}`)
            request.setRequestHeader("Authorization", `Bearer ${getCookie("token")}`);
            request.setRequestHeader("Client-ID", clientid);
            request.setRequestHeader("Content-Type","application/vnd.twitchtv.v5+json");
            request.addEventListener("load", () => {
                // console.info("userid " + request.responseText)
                if(JSON.parse(request.responseText).error !== undefined){
                    return reject(1)
                } else if(JSON.parse(request.responseText).data[0] === undefined){
                    return reject(2)
                } else {
                    return resolve(JSON.parse(request.responseText).data[0].id)
                }
            })
            request.addEventListener("error", () => {
                return reject(request.responseText)
            })
            request.send(null)
        })
    }

    function al(almode, almessage, alcolor, altimeout){
        if(almode === undefined || almode === 0){
            document.getElementById("alert").innerHTML = almessage
            document.getElementById("alert").style.color = alcolor
            document.getElementById("alert").style.display = "block"
            setTimeout(() => {
                document.getElementById("alert").style.display = "none"
            }, altimeout)
        } else if(almode === 1){
            document.getElementById("alert").innerHTML = almessage
            document.getElementById("alert").style.color = alcolor
            document.getElementById("alert").style.display = "block"
            setTimeout(() => {
                document.getElementById("alert").style.display = "none"
            }, altimeout)
        }
    }

    function millisToMinutesAndSeconds(millis) {
      var minutes = Math.floor(millis / 60000);
      var seconds = ((millis % 60000) / 1000).toFixed(0);
      return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
    }

    function removecookies(){
        setCookie("token", "", 0)
        al(0, "Removed token", "aqua", 5000)
        setTimeout(() => {
            window.location.reload()
        }, 5000)
    }

</script>