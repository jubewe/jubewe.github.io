<!DOCTYPE html>
<html lang="en">
<head>
    <title>Regex Generator</title>
    <link rel="icon" href="./src/favicon.ico" type="image/x-icon">
</head>

<body style="background-color: #1d3956; color: mediumseagreen; font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif; text-transform: uppercase; font-size: 20px;">
    <h><center>Login</center></h>
    <br>
    <div id="login">
        <center>
            <h>Please login with your Twitch Account</h>
        </center>
        <br>
        <center>
            <a style="text-decoration: none; border: solid; border-radius: 5px; padding: 5px;" href="https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=ojvz4rc2je8m2l2sqva9tk4zyobzqk&redirect_uri=https://jubewe.github.io/regexgenerator">Login</a>
        </center>
        <br>
        <div id="loginproceed">
            <center>
                Validating token
            </center>
        </div>
        <br><br>
        <center>
            <h style="color: orange;">This switched to approved users only</h>
        </center>
    </div>
    <br>
    <div id="generator" style="display: none;">
        <div>
            <center>
                <h1>
                    Regex Generator
                </h1>
            </center>
        </div>
        <div class="input">
            <center>
                <input id="textinput" type="text" placeholder="Insert Text" minlength="1" oninput="submitregex()">
            </center>
        </div>
        <br>
        <div style="border: solid; padding: 10px;">
            <center>
                <h id="regexoutput" style="text-transform: none;">
                    Regex shows up here
                </h>
                <button id="regexcopy" onclick="copyregex()">
                    Copy Regex
                </button>
                <br>
                <br>
                <h id="regexrawoutput" style="text-transform: none;">
                    Raw Regex shows up here
                </h>
                <button id="regexcopyraw" onclick="copyregexraw()">
                    Copy Raw Regex
                </button>
                <br>
            </center>
        </div>
        <br>
        <div style="user-select: none; float: left; width: 50%;">
            <center>
            <h3 style="text-decoration: underline;">Lookalikes:</h3>
            <h>Usage:</h>
            <br>
            <h>1. <a href="./replaces.txt" download="replaces.txt">Download the Standard File</a></h>
            <br>
            <h>2. Drop your edited File on this page</h>
            <br>
            <br>
            <h>Replaces:</h>
            <br><br>
            <textarea id="embedreplace" style="height: 400px; width: 300px; background-color: darkcyan;" oninput="changereplace()" spellcheck="false">Loading Replaces..</textarea>
            <br><br>
            <button style="background-color: red;" onclick="resetreplace()">Reset Replaces</button>
            </center>
        </div>
        <div style="user-select: none; float: right; width: 50%;">
            <center>
                <h3 style="text-decoration: underline;">Extras:</h3>
                <div style="border: double; padding: 10px; padding-top: 5px; padding-bottom: 5px; display: inline-block; ">
                    <div style="float: left;">
                        <br>
                        <h style="text-decoration: underline; ">Replacer:</h>
                        <input id="replacer" type="text" style="width: 203px; background-color: aquamarine; border: none;" placeholder="Leave Empty for nothing" oninput="replacer()">
                    </div>
                    <br>
                    <div style="float: left;">
                        <h style="text-decoration: underline;">Changer:</h>
                        <input id="changer" type="text" style="width: 207px; background-color: darkcyan; border: none;" placeholder="Leave Empty for nothing" oninput="replacer()">
                    </div>
                    <br>
                    <div style="float: left;">
                        <h style="text-decoration: underline;">Text:</h>
                        <input id="replacetext" type="text" style="width: 250px; background-color: aquamarine; border: none;" placeholder="Lorem ipsum..." oninput="replacer()">
                    </div>
                    <br>
                    <div style="text-transform: none; font-size: 15px;">
                        <input type="checkbox"><h>Case Insensitive</h>
                        <br>
                        <input type="checkbox"><h>Ignore Spaces</h>
                    </div>
                    <br>
                    <div>
                        <form id="replaceoutput" style="text-transform: none; user-select: text;">Output</form>
                    </div>
                    <br>
                </div>
            </center>
        </div>
    </div>
</body>
</html>

<script>
    document.onload = checkvalidate()
    function checkvalidate(){
        if(getCookie("userid") === undefined || getCookie("userid") === ""){
            if(document.URL.includes("#access_token=")){
                validate()
            }
        } else {
            // console.log(getCookie("userid"))
            document.getElementById("generator").style.display = "block"
            document.getElementById("login").style.display = "none"
        }
    }

    function validate(){
        let code = document.URL.split("#access_token=")[1].split("&")[0]
        let request = new XMLHttpRequest();
        request.open("GET", `https://id.twitch.tv/oauth2/validate`)
        request.setRequestHeader("Authorization",`Bearer ${code}`)
        request.addEventListener("load", function(r){
            let dat = JSON.parse(request.response)
            if(dat.status !== undefined){
                // error
                document.getElementById("loginproceed").value = "Errored"
            } else {
                fetch("./login/users.txt")
                .then(data => {
                    data.text()
                    .then(x => {
                        let uids = [];
                        x.split(" ").forEach(a => {
                            uids.push(a)
                        })
                        if(uids.includes(dat.user_id)){
                            document.getElementById("generator").style.display = "block"
                            document.getElementById("login").style.display = "none"
                            // setCookie("userid", dat.user_id, 1)
                        } else {
                            alert("Authentication Failed")
                        }
                    })
                })
            }
        })
        request.addEventListener("error", function(e){
            console.error(e)
        })
        request.send(null)
    }

    function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    
    function checkCookie() {
        let user = getCookie("username");
        if(user !== ""){
            alert("Welcome again " + user);
        } else {
            user = prompt("Please enter your name:", "");
            if (user != "" && user != null) {
                setCookie("username", user, 365);
            }
        }
    } 

    document.onload = syncreplaces(),replacer()

    document.addEventListener("drop", function(ev){
        customreplace(event)
    })

    document.addEventListener("dragover", function(ev){
        customdrag(event)
    })

    let replaces = ""

    function resetreplace(){
        syncreplaces()
    }
    
    function customreplace(ev){
        // console.log("file dropped")
        ev.preventDefault();
        if(ev.dataTransfer.items[0].type === "text/plain"){
            let file = ev.dataTransfer.files[0]
            let reader = new FileReader()
            reader.onload = function(event){
                replaces = event.target.result.replace(/\r/g, "")
                document.getElementById("embedreplace").value = replaces
            }
            reader.readAsText(file)
            // console.log(file)
        }
    }

    function customdrag(ev){
        // console.log("file dragged")
        ev.preventDefault()
    }
    
    function syncreplaces(){
        fetch("./replaces.txt")
        .then(data => {
            data.text().then(x => {
                // console.log(x)
                replaces = x.replace(/(\r)/g, "")
                document.getElementById("embedreplace").value = x.replace(/(\r)/g, "")
                console.log("Successfully Fetched Lookalikes")
            })
        })
        .catch(err => {
            location.reload()
            console.log("Failed to Fetch Lookalikes - Reloading")
        })
    }


    function changereplace(){
        let newdata = document.getElementById("embedreplace").value
        replaces = newdata
    }

    let regex = "config:any regi:"
    let regexraw = ""
    let regexarr = []
    let alphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"]
    let nomatch = ["(", ")"]

    function submitregex(){
        let regextext = document.getElementById("textinput").value
        regexarr = []
        if(regextext.length > 0){
            let num = 0
            regextext.split("").forEach(x => {
                if(x === " "){
                    if(num === 0 || nomatch.includes(regexarr[num-1])){
                        regexarr.push("\\s*")
                    } else {
                        if(regexarr[num-1].endsWith("+[\\W_]*")){
                            regexarr[num-1] = regexarr[num-1].split("+[\\W_]*")[0]
                        } 
                        regexarr.push("+\\s")
                    }
                } else {
                    if(alphabet.includes(x)){
                        if(num === 0 || nomatch.includes(regexarr[num-1])){
                            regexarr.push(`[${replaces.split("\n")[alphabet.indexOf(x)].split(" ")[0]}]+[\\W_]*`)
                        } else {
                            regexarr.push(`+[${replaces.split("\n")[alphabet.indexOf(x)].split(" ")[0]}]+[\\W_]*`)
                        }
                    } else {
                        if(num === 0 || nomatch.includes(regexarr[num-1])){
                            if((x === "(") || (x === ")")){
                                regexarr.push(x)
                            } else {
                                regexarr.push(`${x}+[\\W_]*`)
                            }
                        } else {
                            if((x === "(") || (x === ")")){
                                regexarr.push(x)
                            } else {
                                regexarr.push(`+${x}+[\\W_]*`)
                            }
                        }
                    }
                }
                num++
            })
            document.getElementById("regexoutput").innerHTML = `config:any regi:${regexarr.join("")}`
            document.getElementById("regexrawoutput").innerHTML = `${regexarr.join("")}`
        }
    }
    
    function copyregex(){
        navigator.clipboard.writeText(`config:any regi:${regexarr.join("")}`);
        let colorfirst = document.getElementById("regexcopy").style.backgroundColor
        document.getElementById("regexcopy").style.backgroundColor = "green"
        setTimeout(() => {
            document.getElementById("regexcopy").style.backgroundColor = colorfirst
        }, 3000)
    }

    function copyregexraw(){
        navigator.clipboard.writeText(`${regexarr.join("")}`);
        let colorfirsta = document.getElementById("regexcopyraw").style.backgroundColor
        document.getElementById("regexcopyraw").style.backgroundColor = "green"
        setTimeout(() => {
            document.getElementById("regexcopyraw").style.backgroundColor = colorfirsta
        }, 3000)
    }

    function replacer(){
        let replacer = " "
        if(document.getElementById("replacer").value.length > 0){
            replacer = document.getElementById("replacer").value
        }
    
        let replacetext = "Lorem ipsum..."
        if(document.getElementById("replacetext").value.length > 0){
            replacetext = document.getElementById("replacetext").value
        }

        let changer = ""
        if(document.getElementById("changer").value.length > 0){
            changer = document.getElementById("changer").value
        }

        let caseinsensitive = 0
        let ignorespaces = 0
        
        let output = replacetext.replace(RegExp(replacer.toString(), "g"), changer)
        // console.log(replacetext, replacer, changer)

        document.getElementById("replaceoutput").innerHTML = output
    }

</script>